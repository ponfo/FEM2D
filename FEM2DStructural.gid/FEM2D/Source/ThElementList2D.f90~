module ThElementList2DMOD
  use tools
  use DebuggerMOD

  use Element2DMOD
  use Element2DPtrMOD
  use ThLinTriangElementMOD
  use ThLinQuadElementMOD
  use ThQuadTriangElementMOD
  use ThQuadQuadElementMOD

  use PointPtrTYPE

  use MaterialPtrTYPE

  use IntegratorMOD
  use IntegratorPtrMOD

  implicit none
  private
  public :: ThElementList2DTYPE, thermalElementList2D
  type :: ThElementList2DTYPE
     private
     integer(ikind)                                    :: gaussOrder
     type(Element2DPtrTYPE), dimension(:), allocatable :: element
     type(IntegratorTYPE)                              :: triangIntegrator
     type(IntegratorTYPE)                              :: quadIntegrator
   contains
     procedure, public  :: init
     procedure, public  :: addElement
     procedure, public  :: getGaussOrder
     procedure, public  :: getElement
     procedure, public  :: getTriangIntegrator
     procedure, public  :: getQuadIntegrator
     
     procedure, private :: valueTriangle
     procedure, private :: valueQuad
  end type ThElementList2DTYPE

  interface thermalElementList2D
     procedure constructor
  end interface thermalElementList2D

  procedure(addElementLin), pointer :: addElementPtr => null()

  integer(ikind)               , save                                    :: iTriang
  integer(ikind)               , save                                    :: iQuad
  integer(ikind)               , save                                    :: iElem
  type(ThLinTriangElementTYPE) , save, dimension(:), allocatable, target :: linTriangElem
  type(ThLinQuadElementTYPE)   , save, dimension(:), allocatable, target :: linQuadElem
  type(ThQuadTriangElementTYPE), save, dimension(:), allocatable, target :: quadTriangElem
  type(ThQuadQuadlElementTYPE) , save, dimension(:), allocatable, target :: quadQuadElem
  
contains

  type(ThElementList2DTYPE) function constructor(isQuadratic, nTriangElem, nQuadElem, nGauss)
    implicit none
    integer(ikind), intent(in) :: isQuadratic
    integer(ikind), intent(in) :: nTriangElem
    integer(ikind), intent(in) :: nQuadElem
    integer(ikind), intent(in) :: nGauss
    call constructor%init(isQuadratic, nTriangElem, nQuadElem, nGauss)
  end function constructor
  
  subroutine init(this, isQuadratic, nTriangElem, nQuadElem, nGauss)
    implicit none
    class(ThElementList2DTYPE), intent(inout) :: this
    integer(ikind), intent(in) :: isQuadratic
    integer(ikind), intent(in) :: nTriangElem
    integer(ikind), intent(in) :: nQuadElem
    integer(ikind), intent(in) :: nGauss
    call debugLog('    Initiating ElementList2D')
    iTriang = 0
    iQuad = 0
    iElem = 0
    this%gaussOrder = nGauss
    if(isQuadratic == 0) then
       addElementPtr => addElementLin
       if(nTriangElem > 0) then
          allocate(linTriangElem(nTriangElem))
          call debugLog('      Allocated Linear Triangs: ', size(linTriangElem))
          call linTriangElem(1)%setnPoint(3)
          call linTriangElem(1)%setnDof(1)
          this%triangIntegrator = integrator(nGauss, 'triangle')
          call this%valueTriangle(linTriangElem(1))
       end if
       if(nQuadElem > 0) then
          allocate(linQuadElem(nQuadElem))
          call debugLog('      Allocated Linear Quads: ', size(linQuadElem))
          call linQuadElem(1)%setnPoint(4)
          call linQuadElem(1)%setnDof(1)
          this%quadIntegrator = integrator(nGauss, 'quad')
          call this%valueQuad(linQuadElem(1))
       end if
    else if(isQuadratic == 1) then
       addElementPtr => addElementQuad
       if(nTriangElem > 0) then
          allocate(quadTriangElem(nTriangElem))
          call debugLog('      Allocated Quadratic Triangs: ', size(quadTriangElem))
          call quadTriangElem(1)%setnPoint(6)
          call quadTriangelem(1)%setnDof(1)
          this%triangIntegrator = integrator(nGauss, 'triangle')
          call this%valueTriangle(quadTriangElem(1))
       end if
       if(nQuadElem > 0) then
          allocate(quadQuadElem(nQuadElem))
          call debugLog('      Allocated Quadratic Quads: ', size(quadQuadElem))
          call quadQuadElem(1)%setnPoint(8)
          call quadQuadElem(1)%setnDof(1)
          this%quadIntegrator = integrator(nGauss, 'quad')
          call this%valueQuad(quadQuadElem(1))
       end if
    end if
    allocate(this%element(nTriang+nQuad))
    call debugLog('      Allocated element pointers: ', size(this%element))
  end subroutine init

  subroutine valueTriangle(this, elementInput)
    implicit none
    class(ThElementList2DTYPE), intent(inout) :: this
    class(Element1DTYPE), intent(inout) :: elementInput
    integer(ikind) :: i
    integer(ikind) :: n
    n = elementInput%getnPoint()*elementInput%getnDof()
    allocate(this%triangIntegrator%shapeFunc(this%triangIntegrator%integTerms, n))
    allocate(this%triangIntegrator%dShapeFunc(this%triangIntegrator%integTerms, 2, n))
    do i = 1, this%triangIntegrator%integTerms
       this%triangIntegrator%shapeFunc(i, 1:n) = &
            elementInput%shapefunc(this%triangIntegrator%gPoint(i,1), this%triangIntegrator%gPoint(i,2))
       this%triangIntegrator%dShapeFunc(i, 1:2, 1:n) = &
            elementInput%dShapeFunc(this%triangIntegrator%gPoint(i,1), this%triangIntegrator%gPoint(i,2))
    end do
  end subroutine valueTriangle

  subroutine valueQuad(this, elementInput)
    implicit none
    class(ThElementList2DTYPE), intent(inout) :: this
    class(Element1DTYPE), intent(inout) :: elementInput
    integer(ikind) :: i
    integer(ikind) :: n
    n = elementInput%getnPoint()*elementInput%getnDof()
    allocate(this%quadIntegrator%shapeFunc(this%quadIntegrator%integTerms, n))
    allocate(this%quadIntegrator%dShapeFunc(this%quadIntegrator%integTerms, 2, n))
    do i = 1, this%quadIntegrator%integTerms
       this%quadIntegrator%shapeFunc(i, 1:n) = &
            elementInput%shapefunc(this%quadIntegrator%gPoint(i,1), this%quadIntegrator%gPoint(i,2))
       this%quadIntegrator%dShapeFunc(i, 1:2, 1:n) = &
            elementInput%dShapeFunc(this%quadIntegrator%gPoint(i,1), this%quadIntegrator%gPoint(i,2))
    end do
  end subroutine valueQuad
  
  subroutine addElement(this, iElem, material, point)
    implicit none
    class(ThElementList2DTYPE), intent(inout) :: this
    integer(ikind), intent(in) :: iElem
    type(MaterialPtrTYPE), intent(inout) :: material
    type(PointPtrTYPE), dimension(:), intent(in) :: point
    call addElementPtr(this, iElem, material, point)
  end subroutine addElement
  
  subroutine addElementLin(this, iElem, material, point)
    class(ThElementList2DTYPE), intent(inout) :: this
    integer(ikind), intent(in) :: iElem
    type(MaterialPtrTYPE), intent(inout) :: material
    type(PointPtrTYPE), dimension(:), intent(in) :: point
    integer(ikind) :: i
    iElem = iElem + 1
    if(size(point) == 3) then
       iTriang = iTriang + 1
       linTriangElem(iTriang) = &
            thermalLinearTriangElement(material, point, this%triangIntegrator)
       this%element(iElem) => linTriangElem(iTriang)
    else if(size(point) == 4) then
       iQuad = iQuad + 1
       linQuadElem(iQuad) = &
            thermalLinearQuadElement(material, point, this%quadIntegrator)
       this%element(iElem) => linQuadElem(iQuad)
    end if
  end subroutine addElementLin

  subroutine addElementQuad(this, iElem, material, point)
    class(ThElementList2DTYPE), intent(inout) :: this
    integer(ikind), intent(in) :: iElem
    type(MaterialPtrTYPE), intent(inout) :: material
    type(PointPtrTYPE), dimension(:), intent(in) :: point
    integer(ikind) :: i
    iElem = iElem + 1
    if(size(point) == 6) then
       iTriang = iTriang + 1
       quadTriangElem(iTriang) = &
            thermalQuadTriangElement(material, point, this%triangIntegrator)
       this%element(iElem) => quadTriangElem(iTriang)
    else if(size(point) == 8) then
       iQuad = iQuad + 1
       quadQuadElem(iQuad) = &
            thermalQuadQuadElement(material, point, this%quadIntegrator)
       this%element(iElem) => quadQuadElem(iQuad)
    end if
  end subroutine addElementQuad
    
  integer(ikind) function getGaussOrder(this)
    implicit none
    class(ThElementList2DTYPE), intent(inout) :: this
    getGaussOrder = this%gaussOrder
  end function getGaussOrder

  type(Element2DPtrTYPE) function getElement(this, i)
    implicit none
    class(ThElementList2DTYPE), intent(inout) :: this
    getElement = this%element(i)
  end function getElement

  type(IntegratorPtrTYPE) function getTriangIntegrator(this)
    implicit none
    class(ThElementList2DTYPE), intent(inout) :: this
    getTriangIntegrator => this%TriangItegrator
  end function getTriangIntegrator

  type(IntegratorPtrTYPE) function getQuadIntegrator(this)
    implicit none
    class(ThElementList2DTYPE), intent(inout) :: this
    getQuadIntegrator => this%QuadItegrator
  end function getQuadIntegrator

end module ThElementList2DMOD
